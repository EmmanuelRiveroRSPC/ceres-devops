---
name: Stage-promotion

env:
  IMAGE_NAME: ceres

# Only trigger, when the build workflow succeeded
on:
  workflow_run:
    workflows: ["Dev-Smoke-test"]
    types:
      - completed
  workflow_dispatch:

jobs:
  Setup:
    uses: ./.github/workflows/getVersion.yml
    with:
      image: testdevops
    secrets:
      account:  ${{ secrets.GCP_DEV_ACC }}
      GCPCreds: ${{ secrets.GCP_DEV }} 

  promotion:
    runs-on: ubuntu-latest
    needs: Setup

    steps:

      ### Seting up runner env ###
      - uses: actions/checkout@v3
      
      - uses: 'google-github-actions/auth@v0'
        with:
          credentials_json: '${{ secrets.GCP_DEV }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v0'

      - name: 'Set up Jfrog CLI'
        uses: jfrog/setup-jfrog-cli@v2

      - name: 'Maven settings'
        run: 'gsutil cp gs://salus-mavenrepository/m2-settings.xml ./.mvn/settings.xml'

      - name: .m2 forder [*** fix it please ***]
        run: sed -i 's*/root/.m2/*./.m2/*g' ./.mvn/settings.xml

      #Promoting image & artifact
      - name: 'Image promotion'
        run: gcloud container images add-tag gcr.io/${{ secrets.GCP_DEV_ACC }}/testdevops:latest gcr.io/${{ secrets.GCP_DEV_ACC }}/testdevops:${{ needs.Setup.outputs.new_version }}

      - name: 'POM promotion'
        shell: bash
        run: |
          mvn versions:set -DnewVersion=${{ needs.Setup.outputs.new_version }}
          git config --global user.email "mmi-automation@rackspace.com"
          git config --global user.name "mmi-automation"
          git add ./pom.xml
          git commit -m "${{github.workflow }}: ${{ github.run_number }} - POM.xml update new version: ${{ needs.Setup.outputs.new_version }}" || true
          git push origin master || true

      - name: 'Artifact promotion'
        shell: bash
        run: |
          mvn dependency:get -DremoteRepositories=snapshots \
                            -DgroupId=com.rackspace.ceres \
                            -DartifactId=ceres \
                            -Dversion=0.0.1-SNAPSHOT \
                            -Dtransitive=false \
                            -Ddest=./ceres-{{ needs.Setup.outputs.new_version }}.jar
          
          #mvn deploy:deploy-file -Dfile=${{ needs.Setup.outputs.new_version }}.jar -DrepositoryId=libs-release -DartifactId=ceres -DartifactId=com.rackspace.ceres
        
      - name: test
        run: |
          ls
          md5sum ceres-${{ needs.Setup.outputs.new_version }}.jar

  Stage-Deploy:
    runs-on: ubuntu-latest
    needs: [promotion]

    steps:
      - name: Checkout helm-repo
        uses: actions/checkout@v3
        with:
          repository: rax-maas/helm-ceres
          ref: master
          path: helm-ceres
          token: ${{ secrets.GIT_TOKEN }}
      
      - name: test helm
        run: helm show values helm-ceres/charts/ceres

#      - name: Helm upgrade
#        run: helm upgrade helm-ceres $HELM_CHART --set image.repository=${IMAGE_NAME}@sha256,image.tag=${{ needs.Setup.outputs.new_version }}      
